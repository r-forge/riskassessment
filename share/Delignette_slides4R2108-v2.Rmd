---
title: "New goodness-of-fit plots for censored data in the package **fitdistrplus**"
author: |
 | M.L. Delignette-Muller (LBBE, Lyon)
 | C. Dutang (CEREMADE, Paris) and 
 | A. Siberchicot (LBBE, Lyon)
date: "July 6th 2018"
output:
  beamer_presentation:
    theme: "Antibes"
    toc: true
    fig_width: 8
    fig_height: 6
    fig_caption: false
---
```{r, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}
options(digits = 3)
require(fitdistrplus)
set.seed(123)
source("plotdistcensmod4R2018.R")
addbounds <- function(d)
{
  xbounds <- c(d$left, d$right)
  xboundsnotNA <- xbounds[!is.na(xbounds)]
  abline(v = xboundsnotNA, col = "grey")
}
addTurnbull <- function(d, conf.int = FALSE)
{
  (survdata <- Surv(time = d$left, time2 = d$right, type="interval2"))
  survfitted <- survfit(Surv(left, right, type="interval2") ~ 1, data = d)
  points(survfitted$time, 1 - survfitted$surv, col = "orange", type = "s", 
         lwd = 5, lty = 2)
  if (conf.int == TRUE)
  {
      points(survfitted$time, 1 - survfitted$lower, col = "orange", type = "s", 
             lwd = 2, lty = 3)
      points(survfitted$time, 1 - survfitted$upper, col = "orange", type = "s", 
             lwd = 2, lty = 3)
  }
}
```

# Goodness-of-fit plots for non censored data


## General presentation of the package fitdistrplus
A package to help the **fit of parametric distributions** to 
univariate discrete our continuous data.

* stable version 1.0-9 on **CRAN** (first release in 2009): [https://cran.r-project.org/web/packages/fitdistrplus](https://cran.r-project.org/web/packages/fitdistrplus)
* version 1.0-10 in development on **Rforge** (soon on CRAN): [https://rdrr.io/rforge/fitdistrplus/](https://rdrr.io/rforge/fitdistrplus/)
* Delignette-Muller, M. L., & Dutang, C. (2015). fitdistrplus: An R package for fitting distributions. **Journal of Statistical Software**, 64(4), 1-34. (311 citations in scholar google)

The package provides, among others, tools to
assess/compare the goodness-of-fit of various distributions on a same data set.

**Left, right and interval censored** continuous data can be handled. 

We will present you
**new goodness-of-fit plots for such data** available in version 1.0-10.


## An example with non censored data
```{r}
r <- rweibull(100, shape = 3, scale = 1)
fw <- fitdist(r, "weibull")
fg <- fitdist(r, "gamma")
fl <- fitdist(r, "lnorm")
gofstat(list(fw, fg, fl), 
        fitnames = c("Weibull", "gamma", "lnorm"))
```

## Goodness-of-fit plot in density plot
```{r}
denscomp(list(fw, fg, fl), demp = TRUE, fitlty = 1)
```

## Goodness-of-fit plot in CDF plot
```{r}
cdfcomp(list(fw, fg, fl), fitlty = 1)
```

## The Q-Q plot which emphasizes differences at tails
```{r}
qqcomp(list(fw, fg, fl))
```

## The P-P plot which emphasizes differences in the center
```{r}
ppcomp(list(fw, fg, fl))
```

# Representation of the ECDF for censored data

## How to represent an ECDF from censored data ? 

**A first toy example**
```{r, echo = FALSE}
d0 <- data.frame(left = c(NA, 2, 4, 7, 10), right = c(1, 2.5, 6, 8, NA))
d <- d0
```
```{r}
d
```
```{r, echo = FALSE, fig.height=2}
par(mar = c(3, 4, 0.1, 0.1))
plotdistcens(d, NPMLE = FALSE, lwd = 5, col = "blue") 
```


## The CDF plot from the package survival
```{r, echo = FALSE,fig.height=5}
par(mar = c(3, 4, 0.1, 0.1))
layout(matrix(c(1,2,2,2), nrow =4, byrow = TRUE))
par(mar = c(3, 4, 0.1, 0.1))
plotdistcens(d, NPMLE = FALSE, lwd = 5, col = "blue")
addbounds(d)
plotdistcens(d, NPMLE.method = "Turnbull", lwd = 5, col = "orange")
addbounds(d)
```

The Turnbull plot implemented in the package survival and used in former versions 
of fitdistrplus.

## The Turnbull plot with confidence intervals
```{r, echo = FALSE}
par(mar = c(3, 4, 0.1, 0.1))
layout(matrix(c(1,2,2,2), nrow =4, byrow = TRUE))
par(mar = c(3, 4, 0.1, 0.1))
plotdistcens(d, NPMLE = FALSE, lwd = 5, col = "blue")
addbounds(d)
plotdistcens(d, NPMLE.method = "Turnbull", Turnbull.confint = TRUE, lwd = 5, col = "orange")
addbounds(d)
```

## A new plot from the package npsurv (Wang plot)
```{r, echo = FALSE}
# par(mfrow = c(2, 1))
layout(matrix(c(1,2,2,2), nrow =4, byrow = TRUE))
par(mar = c(3, 4, 0.1, 0.1))
plotdistcens(d, NPMLE = FALSE, lwd = 5, col = "blue")
addbounds(d)
plotdistcens(d, NPMLE = TRUE, lwd = 5)
addTurnbull(d)
addbounds(d)
legend("right", lty = c(1,2), lwd = c(5,5), col = c("black", "orange"),
       legend = c("Wang", "Turnbull"), bty = "n", cex = 2)
```

## A second toy example with overlapping intervals
```{r, echo = FALSE}
d0b <- data.frame(left = c(NA, 2, 4, 6, 10), right = c(1, 3, 7, 8, NA))
d <- d0b
```
```{r, echo = FALSE}
# par(mfrow = c(2, 1))
layout(matrix(c(1,2,2,2), nrow =4, byrow = TRUE))
par(mar = c(3, 4, 0.1, 0.1))
plotdistcens(d, NPMLE = FALSE, lwd = 5, col = "blue")
addbounds(d)
plotdistcens(d, NPMLE = TRUE, lwd = 5)
addTurnbull(d)
addbounds(d)
legend("right", lty = c(1,2), lwd = c(5,5), col = c("black", "orange"),
       legend = c("Wang", "Turnbull"), bty = "n", cex = 2)
```

## The two steps of an NPMLE algorithm (Non Parametric Maximum Likelihood Estimation) 

* Identification of **equivalence classes** (also named **Turnbull intervals** or **maximal intersection intervals** or **innermost intervals** or **maximal cliques** of the data) 
= set of points/intervals under which the ECDF may change (each region between each left bound immediately followed by a right bound). The NPMLE is unique only up to these equivalence classes (non uniqueness represented by grey rectangles).

* Assign a **probability mass** to each equivalence class (may be 0).

Various algorithms implemented in the packages **Icens**, **interval** and **npsurv** (more or less performant and not all handling left censored data).

## A third toy example including non censored data
```{r, echo = FALSE}
d1 <- data.frame(left = c(1, 2, 3, 4, 3, 7), right = c(2, 5, 3, 7, 8, NA))
d <- d1
```
```{r, echo = FALSE}
# par(mfrow = c(2, 1))
layout(matrix(c(1,2,2,2), nrow =4, byrow = TRUE))
par(mar = c(3, 4, 0.1, 0.1))
plotdistcens(d, NPMLE = FALSE, lwd = 5, col = "blue")
addbounds(d)
plotdistcens(d, NPMLE = TRUE, lwd = 5)
addTurnbull(d)
addbounds(d)
legend("right", lty = c(1,2), lwd = c(5,5), col = c("black", "orange"),
       legend = c("Wang", "Turnbull"), bty = "n", cex = 2)
```


## A 4th toy example
```{r, echo = FALSE}
d3 <- data.frame(left = c(-1.4, -1.4, 2, -1.4, 0),
                 right = c(1, 2, NA, 0, 2))
d <- d3
```
```{r, echo = FALSE}
# par(mfrow = c(2, 1))
layout(matrix(c(1,2,2,2), nrow =4, byrow = TRUE))
par(mar = c(3, 4, 0.1, 0.1))
plotdistcens(d, NPMLE = FALSE, lwd = 5, col = "blue")
addbounds(d)
plotdistcens(d, NPMLE = TRUE, lwd = 5)
addTurnbull(d)
addbounds(d)
legend("right", lty = c(1,2), lwd = c(5,5), col = c("black", "orange"),
       legend = c("Wang", "Turnbull"), bty = "n", cex = 2)
```

## The 4th toy example with the add of a non censored obs.
```{r, echo = FALSE}
d3b <- data.frame(left = c(1.18, -1.4, -1.4, 2, -1.4, 0),
                 right = c(1.18, 1, 2, NA, 0, 2))
d <- d3b
```
```{r, echo = FALSE}
# par(mfrow = c(2, 1))
layout(matrix(c(1,2,2,2), nrow =4, byrow = TRUE))
par(mar = c(3, 4, 0.1, 0.1))
plotdistcens(d, NPMLE = FALSE, lwd = 5, col = "blue")
addbounds(d)
plotdistcens(d, NPMLE = TRUE, lwd = 5)
addTurnbull(d)
addbounds(d)
legend("right", lty = c(1,2), lwd = c(5,5), col = c("black", "orange"),
       legend = c("Wang", "Turnbull"), bty = "n", cex = 2)
```

# New CDF, Q-Q and P-P plots implemented for censored data

## Use of cdfcompcens() to assess the fit of 3 distributions on data smokedfish
```{r, echo = FALSE}
data(smokedfish)
d <-  log10(smokedfish)
fitsfn <- fitdistcens(d,"norm")
fitsfl <- fitdistcens(d,"logis")
dgumbel <- function(x,a,b) 1/b*exp((a-x)/b)*exp(-exp((a-x)/b))
pgumbel <- function(q,a,b) exp(-exp((a-q)/b))
qgumbel <- function(p,a,b) a-b*log(-log(p))
fitsfg<-fitdistcens(d,"gumbel",start=list(a=-3,b=3))
```
```{r, echo = FALSE}
# par(mfrow = c(2, 1))
layout(matrix(c(1,2,2,2), nrow =4, byrow = TRUE))
par(mar = c(3, 4, 2, 0.1))
plotdistcens(d, NPMLE = FALSE, lwd = 0.15)
# addbounds(d)
cdfcompcens(list(fitsfn,fitsfl,fitsfg), fitlty = 1)
# addbounds(d)
```

## Use of qqcompcens() for one distribution
```{r, echo = FALSE, fig.height = 6, fig.width = 10}
par(mfrow = c(1, 2))
par(mar = c(4, 4, 2, 1))
cdfcompcens(fitsfn, fitlty = 1)
qqcompcens(fitsfn)
```

## Use of ppcompcens() for one distribution
```{r, echo = FALSE, fig.height = 6, fig.width = 10}
par(mfrow = c(1, 2))
par(mar = c(4, 4, 2, 1))
cdfcompcens(fitsfn, fitlty = 1)
ppcompcens(fitsfn)
```


## Q-Q plots and P-P plot for the 3 distributions
```{r, echo = FALSE, fig.height = 6, fig.width = 10}
par(mfrow = c(1, 2))
par(mar = c(4, 4, 2, 1))
qqcompcens(list(fitsfn,fitsfl,fitsfg))
ppcompcens(list(fitsfn,fitsfl,fitsfg))
```

## An alternative presentation of the Q-Q plot for the 3 dist. 
```{r, echo = FALSE, fig.height = 7, fig.width = 8}
par(mfrow = c(2,2))
par(mar = c(4, 4, 2, 1))
qqcompcens(fitsfn)
qqcompcens(fitsfl)
qqcompcens(fitsfg)
```

Will be soon implemented in the plotstyle ggplot.

## How to use of these new goodness-of-fit plots ?

Example of code:
```{r, eval = FALSE}
data(smokedfish)
d <-  log10(smokedfish)
# Plot of the NPMLE CDF on censored data
plotdistcens(d)
# Two MLE fits
fitsfn <- fitdistcens(d,"norm")
fitsfl <- fitdistcens(d,"logis")
# Three goodness-of-fit plots for one fit
plot(fitsfn)
# Goodness-of-fit plots for one or more fits
cdfcompcens(list(fitsfn,fitsfl))
qqcompcens(list(fitsfn,fitsfl))
ppcompcens(list(fitsfn,fitsfl))
```

We are waiting for your feedback on these new tools.

## Other main improvements of fitdistrplus 

**Version 1.0-7**

* Start of a FAQ vignette continuously updated in each new version.

**Version 1.0-8**

* add of an optional use of ggplot2 in cdfcomp(), denscomp(), qqcomp() and ppcomp().

**Version 1.0-10**

* Improvement of goodness-of-fit plots for discrete distributions in denscomp().
* Add of new default starting values for distributions in actuar.

**Version 1.0-11**

* add of an optional use of ggplot2 in cdfcompcens(), denscompcens() and ppcompcens().


## References
* Turnbull BW (1974). Nonparametric estimation of a survivorship function with doubly censored data. Journal of American Statistical Association, 69, 169-173.
* Gentleman, R., & Geyer, C. J. (1994). Maximum likelihood for interval censored data: Consistency and computation. Biometrika, 81(3), 618-623.
* Wang, Y. (2008). Dimension-reduced nonparametric maximum likelihood computation for interval-censored data. Computational Statistics & Data Analysis, 52(5), 2388-2402.
* Wang, Y., & Taylor, S. M. (2013). Efficient computation of nonparametric survival functions via a hierarchical mixture formulation. Statistics and Computing, 23(6), 713-725.
* Wang, Y., & Fani, S. (2018). Nonparametric maximum likelihood computation of a U-shaped hazard function. Statistics and Computing, 28(1), 187-200.
